# Marshall County, IA

#library(dplyr)
library(tidycensus)
library(tigris)
library(ggplot2)
library(acs)
library(data.table)
library(mapproj)
source("functions/theme_map.R")

census_api_key("853b2a1e71aa0aff0f3db966545e8898c73f0772")

year = 2015
span = 5
state_names <- "IA"
county_names <- c("Marshall County")


# # The four variables going into the EVI composite index are:
# # 1. Housing burden (rent, or mortage/other costs are >50% HH income)
# # 2. %HH with no vehicles
# # 3. %HH on SNAP
# # 4. %HH in poverty
#
# # LOOK UP ACS VARIABLE NAMES
# # --------------------------------------------------
# # 1. Households spending >50% HH income on housing
# View( acs.lookup(endyear=year, span = span, dataset = "acs", table.number = "B25070")@results )
# # B25070_001: total HH renters
# # B25070_010: rent is 50% or more of HH income
#
# View( acs.lookup(endyear=year, span = span, dataset = "acs", table.number = "B25091")@results )
# # B25091_001: total HH owners
# # B25091_011: HH with a mortage, costs are 50% or more of HH income
# # B25091_022: HH without a mortage, costs are 50% or more of HH income
# # --------------------------------------------------
# # 2. %HH with no vehicles
# View( acs.lookup(endyear=year, span = span, dataset = "acs", table.number = "B25044")@results )
# # B25044_001: total HH
# # B25044_003: Owner occupied: No vehicle available
# # B25044_010: Renter occupied: No vehicle available
# # --------------------------------------------------
# # 3. %HH on SNAP
# View( acs.lookup(endyear=year, span = span, dataset = "acs", table.number = "B22010")@results )
# # B22010_001: total HH
# # B22010_002: HH received SNAP in the past 12 months
# # --------------------------------------------------
# # 4. %HH in poverty
# View( acs.lookup(endyear=year, span = span, dataset = "acs", table.number = "B17021")@results )
# # B17021_001: total HH
# # B17021_002: Income in the past 12 months below poverty level
# # --------------------------------------------------

acs_vars <- c(
  "B25070_001","B25070_010",
  "B25091_001","B25091_011","B25091_022",
  "B25044_001","B25044_003","B25044_010",
  "B22010_001","B22010_002",
  "B17021_001","B17021_002"
)
acs_est <- get_acs(geography="block group",state=state_names,county=county_names,
                   variables=acs_vars,year=year,cache_table=TRUE,output="wide", geometry = TRUE)

# convert from sf object to data.table
setDT(acs_est)

# compute variables for the EVI composite index using ACS columns
EVI_dt <- acs_est[, .(GEOID,
                      housing_burden=(B25070_010E+B25091_011E+B25091_022E)/(B25070_001E+B25091_001E),
                      no_vehicles=(B25044_003E+B25044_010E)/B25044_001E,
                      snap=B22010_002E/B22010_001E,
                      poverty=B17021_002E/B17021_001E,
                      geometry)]

# rank and sum these variables across all block groups to get the composite index for EVI
# EVI is scaled from 0 (lowest vulnerability) to 1 (highest)
# then take quintiles of EVI and label from 1 to 5
EVI_dt[, housing_burden_rank := rank(housing_burden)] %>%
     .[, no_vehicles_rank := rank(no_vehicles)] %>%
     .[, snap_rank := rank(snap)] %>%
     .[, poverty_rank := rank(poverty)] %>%
     .[, EVI := (housing_burden_rank+no_vehicles_rank+snap_rank+poverty_rank)/(4*nrow(EVI_dt))] %>%
     .[, rank := cut(EVI,breaks=quantile(EVI,probs=seq(0,1,by=0.2)),labels=1:5,include.lowest=TRUE)]

# convert back to sf object
EVI_sf <- sf::st_as_sf(EVI_dt)

# --------------------------------------------------
# plot EVI across Fairfax County
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
EVI_palette<-cbPalette[c(6,3,1,5,7)]

# exclude the most remote block groups
excld <- c("191279501004","191279502002","191279502003","191279502001","191279503002","191279503003","191279503004","191279504004")
EVI_sf <- EVI_sf[!EVI_sf$GEOID %in% excld,]

# create map
p <- ggplot(data = EVI_sf) +
  theme_map() +
  coord_map() +
  geom_sf(aes(fill = rank), color = "grey20") +
  scale_fill_manual(
    values = EVI_palette,
    name = "Economic Vulnerability Index Quantiles",
    drop = FALSE,
    labels = c("Low Vulnerability", "", "", "", "High Vulnerability"),
    guide = guide_legend(
      direction = "horizontal",
      keyheight = unit(2, units = "mm"),
      keywidth = unit(30 / length(labels), units = "mm"),
      title.position = 'top',
      title.hjust = 0.5,
      label.hjust = 1,
      nrow = 1,
      byrow = T,
      reverse = F,
      label.position = "bottom"
    )
  ) + theme(legend.position = "bottom") +
  labs(
    x = NULL,
    y = NULL,
    title = "Economic Vulnerability Index Quantiles",
    subtitle = "Marshalltown, Census ACS, 2015",
    caption = "Geometries: Census Block Groups, 2010"
)

p
